<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5" />
    <title>bercriber's blog</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="icon" href="/public/favicon.ico" />
    
  </head>
  <body>
    
      <header class="header">
        <h2 class="header-title">Bercriber's Blog</h2>
        <img class="header-icon" src="/public/bercriber.jpg" />
      </header>
    

    
    
  </body>
</html>


<div class="tags-list">


  
    <a class="tags-list-elem" href="/blog/tag/プログラミング">プログラミング</a>
  

</div>




<div class="post-header">
  <p class="post-date">2021/01/12 21:20</p>
  <hr>
  <h2 class="post-title">set Test &quot;POP AF&quot;</h2>
</div>

<div class="post-main">

  <p>本当に悩んで考えて、どうしてもわからなかったから、出てくるわけないだろと思って、テストコードそのままぐぐったら出てきた。</p>
<p><a href="https://stackoverflow.com/questions/23037456/gb-test-rom-emulation-issues">gb-test-rom-emulation-issues</a></p>
<p>つまりFの下位4ビットは何か値が書き込まれても無視するということ。</p>
<pre><code class="language-asm">     set_test 5,&quot;POP AF&quot;
     ld   bc,$1200
-    push bc
     pop  af
     push af
     pop  de
     ld   a,c
     and  $F0
     cp   e
     jp   nz,test_failed
     inc  b
     inc  c
     jr   nz,-

</code></pre>
<p>以下、自分の実装。どうやってもこれで正解だろうと思ってた。命令に間違えがあるのかと必死で見直してたのに、レジスタが突っぱねてるなんて、まったく考えもしなかった。どうせどっかに書いてあって見落としていたのだろうけど。無念。非常に悔しい。</p>
<ul>
<li>
<p>BC = $1200</p>
</li>
<li>
<p>loop 1回目</p>
<ul>
<li>BC == $1200</li>
<li>AF = $1200</li>
<li>DE = $1200</li>
<li>A = C</li>
<li>A = A &amp; $F0; 上位4ビットだけ取り出す</li>
<li>A - E; $0 - $0; Zero = 1</li>
<li>jp test_failed if Zero == 0; Zero = 1なのでジャンプしない。</li>
<li>B++; $13</li>
<li>C++; $01</li>
<li>jp loop</li>
</ul>
</li>
<li>
<p>loop 2回目</p>
<ul>
<li>BC == $1301</li>
<li>AF = $1301</li>
<li>DE = $1301</li>
<li>A = C; A = $01</li>
<li>A = A &amp; $F0; A = $01 &amp; $F0. A = 0</li>
<li>A - E; $0 - $1 = $FF. Zero = 0</li>
<li>jp test_failed if Zero == 0; Zero = 0なのでジャンプでテスト失敗</li>
</ul>
</li>
</ul>


</div>
