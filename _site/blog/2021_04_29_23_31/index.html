<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5" />
    <title>bercriber's blog</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="icon" href="/public/favicon.ico" />
    
  </head>
  <body>
    
      <header class="header">
        <h2 class="header-title">Bercriber's Blog</h2>
        <img class="header-icon" src="/public/bercriber.jpg" />
      </header>
    

    
    
  </body>
</html>


<div class="tags-list">


  
    <a class="tags-list-elem" href="/blog/tag/プログラミング">プログラミング</a>
  

</div>




<div class="post-header">
  <p class="post-date">2021/04/29 23:31</p>
  <hr>
  <h2 class="post-title">APIを使ってMarkdownをはてなブログに投稿する</h2>
</div>

<div class="post-main">

  <ul>
<li>はまったこと
<ul>
<li><code>&lt;content type=&quot;text/x-markdown&quot;&gt;</code>を指定してもplain textで投稿されてしまう</li>
</ul>
</li>
<li>対策
<ul>
<li>ブログの設定画面からデフォルトの編集モードをMarkdownモードに設定する。</li>
</ul>
</li>
</ul>
<pre><code class="language-javascript">const http = require('https')
const fs = require('fs')
const process = require('process')
const matter = require('gray-matter')
const escapeHtml = require('escape-html')

const USER = 'hoge'
const APIKEY = 'fuga'
const APIURL = 'https://blog.hatena.ne.jp/$user/$user_blog_url/atom'
const KEY = USER + &quot;:&quot; + APIKEY

const post = fs.readFileSync(process.argv[2], 'utf8')
const gray = matter(post)

//http.get(APIURL + '/entry', {auth: KEY}, (res) =&gt; {
//  let data = ''
//  res.on('data', (chunk) =&gt; data += chunk)
//  res.on('end', () =&gt; console.log(data))
//})

const date = (new Date())).toLocaleString()

const category = gray.data.category.split(/\s+/).map(c =&gt; `&lt;category term=&quot;${c}&quot; /&gt;`).join('\n')

const xml = `\
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;entry xmlns=&quot;http://www.w3.org/2005/Atom&quot;
       xmlns:app=&quot;http://www.w3.org/2007/app&quot;&gt;
  &lt;title&gt;${gray.data.title}&lt;/title&gt;
  &lt;author&gt;&lt;name&gt;bercriber&lt;/name&gt;&lt;/author&gt;
  &lt;content type=&quot;text/x-markdown&quot;&gt;
  ${escapeHtml(gray.content)}
  &lt;/content&gt;
  &lt;updated&gt;${date}&lt;/updated&gt;
  ${category}
&lt;/entry&gt;
`

let req = http.request(
  APIURL + '/entry', 
  {
    method: 'POST',
    auth: KEY,
    //headers: {
    //  'Content-Length': Buffer.byteLength(xml)
    //}
  }, 
  (res) =&gt; {
    console.log(res.statusCode)
  }
)
req.on('error', (e) =&gt; console.error('hatenaPost error: ' + e))
req.write(xml, 'utf8')
req.end()
</code></pre>


</div>
