<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5" />
    <title>bercriber's blog</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="icon" href="/public/favicon.ico" />
    
  </head>
  <body>
    
      <header class="header">
        <h2 class="header-title">Bercriber's Blog</h2>
        <img class="header-icon" src="/public/bercriber.jpg" />
      </header>
    

    
    
  </body>
</html>


<div class="tags-list">


  
    <a class="tags-list-elem" href="/blog/tag/プログラミング">プログラミング</a>
  

</div>




<div class="post-header">
  <p class="post-date">2022/02/23 19:27</p>
  <hr>
  <h2 class="post-title">またゲームボーイエミュレータ触ってる</h2>
</div>

<div class="post-main">

  <p><img src="https://pbs.twimg.com/media/FMRkXZ6aAAMX71u?format=png&amp;name=4096x4096" alt=""></p>
<p>一年位放置してたゲームボーイエミュレータをここ一週間位気になりだして触ってる。前回まではコントローラーの実装が良くなくてオープニングムービーは流れるけど、そこから操作できず進めないというところで詰んでた。そのへんを考え直して実装し直した。</p>
<p>ジョイパッド操作を読むとき、JOYPに書き込みが発生する。アクションか矢印のどちらとしてキーマトリックスを認識するかフラグを立てる。フラグが立ったタイミングでJOYPにジョイパッド入力を書き込む。それだけのことなんだけど。GUIのキーイベントのタイミングでJOYPを更新してたので、CPUのタイミングとマッチしていなくて認識されなかった。キーマトリックス操作のレジスタの性質上、JOYPは一回リセットが入るので、CPUのJOYPのWrite/Readのタイミングで実際のキー入力を別で保存しておいたデータからJOYPを生成する必要があった。ソフト側からキーマトリックスを操作する感じを理解できていなかったのが敗因。</p>
<p>ディスプレイも、スプライトの位置やウィンドウの位置が合わなかったりしてたけど、これも解決した。バックグランドマップ上でのOAM[0,1]、WX、WYかと思ってたけど違って、144x160の実際の液晶ディスプレイ上での位置だった。BGマップはSCX,SCYでくり抜かれる用のバッファーだった。グローバルなバッファーがあってそこに全部書き込まれてて、スクロールで抜き出す認識だったけど全然違った。PPUはだいたいこれで良くなったが、まだ表示されないスプライトがあったり、なぜか肝心のプレイヤー、リンクが表示されなかったりしてる。スプライトのYかXが0であった場合、そのスプライトは表示されない。リンクのOAMもなぜかYが0になっていて表示されない。MBCにlogを噛ませてみると、どうも正しい座標を書き込んではいるが、すぐリセットもされていて、ディスプレイのレンダリングのタイミングではリセットされてるので表示されないっぽい。PPUのフラグ管理かクロックの同期が悪いのか、てかなんでプレイヤーの座標のリセット入るんだよ。またしばらく詰みかなぁ...タイマー、割り込み系が怪しいかとおもったけど、LCDC以外割り込み発生してないっぽいし...わからんな...</p>
<p>PPUしっかり実装できても、APU（音）まったく触ってないのでまだやることたくさんありそうで良い。MBCもMBC3RTCとかやらんと、ポケモン動かないからな。長いな。</p>


</div>
