---
date: 2022-03-07 18:41:00
title: たなこふ先生のRustでGBE
tags: プログラミング
---
[Rustでゲームボーイエミュレーターを書いた](https://zenn.dev/tanakh/articles/gb-emulator-in-rust)


僕は最初、Rustで書こうとしたが所有権のあれこれをクリアできず挫折した。
メモリを`Rc<RefCell<Memory>`とかでごまかそうとしたけど、さすがにあかんやろて思った。
`Rc<RefCell<>>`のオーバーヘッドがどれくらいなのか知らんけど、メモリアクセス毎に`memory.borrow()[addr];borrow_mut()[addr] += 1`ではむりがあるよなぁと詰んでた。


```rust
struct MBC {
  ram: RefCell<Vec<u8>>
}

struct CPU {
  mbc: Rc<MBC>
}

struct PPU {
  mbc: Rc<MBC>
}
```


こんなかんじで、CPUとPPUからメモリにアクセスしたいと考えていたので構造体に組み込んでいたわけだけど、これじゃだめで


```rust

impl Gameboy {
  mbc: MBC;
  cpu: CPU;
  ppu: PPU;

  fn exec(&self) {
    self.cpu.exec(&mut self.mbc);
    self.ppu.exec(&mut self.mbc);
  }
}

```


こんなかんじになるのかもしれない。不要な時は無駄に引き回したりせずに、必要な時に必要な権限を与えてあげるということを徹底するといいのかもしれない。俺はこの程度のこともわからんかったんだな。。。結局[Typescriptで書いたGBE](https://github.com/kmtoki/gbgb)は上側の構造体になっている。


[たなこふ先生のCPUのマクロ](https://github.com/tanakh/tgbr/blob/master/tgbr-core/src/cpu.rs)は狂気じみてるが、しこしこ手で書いていた僕も書きながらマクロでなんとかなりそうだなとか思いながらTS書いてたな。ここまでショートカットできるなんて思いもしなかったので怖い。
